<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø³Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© - Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„</title>

    <!-- Bootstrap 5.3 RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .header-datetime {
            font-size: 0.95rem;
            opacity: 0.95;
            font-weight: 500;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 15px 20px;
            font-weight: bold;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            color: white;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .stat-card-1 { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .stat-card-2 { background: linear-gradient(135deg, #2980b9, #3498db); }
        .stat-card-3 { background: linear-gradient(135deg, #e67e22, #f39c12); }
        .stat-card-4 { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .stat-card-5 { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .stat-card-6 { background: linear-gradient(135deg, #16a085, #1abc9c); }

        .stat-card h2 {
            margin: 0;
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            font-size: 0.95rem;
        }

        .monthly-stats-section {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .monthly-stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-width: 150px;
        }

        .monthly-stat-item strong {
            display: block;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .monthly-stat-item .value {
            display: block;
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .btn {
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .table {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            background-color: #f1f8ff;
            border-bottom: 2px solid #dee2e6;
            font-weight: 700;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 10px 15px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .low-stock { background-color: #fff3cd !important; }
        .out-stock { background-color: #f8d7da !important; }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .stat-card h2 { font-size: 1.5rem; }
            .monthly-stats-section {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .main-menu {
            margin: 10px 0 20px 0;
        }

        .menu-tile {
            background: white;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .menu-tile:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .menu-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }

        .menu-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .floating-panel-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1050;
        }

        .floating-panel {
            background: #ffffff;
            border-radius: 14px;
            max-width: 1100px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 15px;
        }

        .floating-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .floating-panel-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .floating-panel-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
        }

        /* ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-page {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            text-align: center;
        }

        .login-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .login-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .login-body {
            padding: 25px;
        }

        .user-selection {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .user-option {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-option:hover {
            border-color: var(--secondary-color);
            background-color: #f8f9fa;
        }

        .user-option.active {
            border-color: var(--secondary-color);
            background-color: #e3f2fd;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .user-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .user-name {
            font-weight: bold;
            color: var(--dark-color);
        }

        .btn-login {
            padding: 12px;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .login-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 576px) {
            .menu-tile {
                padding: 12px 5px;
            }
            .menu-icon {
                font-size: 1.5rem;
            }
            .menu-title {
                font-size: 0.8rem;
            }
            .floating-panel {
                width: 98%;
                padding: 10px;
            }
            .user-selection {
                flex-direction: column;
            }
        }

        .btn:active {
            transform: scale(0.98);
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 3px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Firebase SDK (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h2>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø³Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©</h2>
                    <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
                </div>
                
                <div class="login-body">
                    <div class="user-selection">
                        <div class="user-option" data-user="Ù…Ø¹ØªØ²">
                            <div class="user-icon">ğŸ‘¨â€ğŸ’¼</div>
                            <div class="user-name">Ù…Ø¹ØªØ²</div>
                        </div>
                        <div class="user-option" data-user="Ù…ØµØ·ÙÙŠ">
                            <div class="user-icon">ğŸ‘¨â€ğŸ’»</div>
                            <div class="user-name">Ù…ØµØ·ÙÙŠ</div>
                        </div>
                    </div>
                    
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginUsername" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <input type="text" class="form-control" id="loginUsername" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-login">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                            <button type="button" class="btn btn-secondary" id="btnClearLogin">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
                        </div>
                    </form>
                    
                    <div class="login-footer">
                        <p class="text-muted">Ø¨Ø±Ù…Ø¬Ø© Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ Ø­Ù…Ø§Ø¯</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…Ø®ÙÙŠ Ø­ØªÙ‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h1 class="mb-2">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø³Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©</h1>
                        <p class="mb-1">Ù…Ø¨ÙŠØ¹Ø§Øª - Ù…Ø®Ø²ÙˆÙ† - ØµÙŠØ§Ù†Ø© - Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                        <p class="mb-0 header-datetime">
                            <span id="currentDateTime">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                            <span id="loggedUserInfo" class="user-badge"></span>
                        </p>
                    </div>
                    <div class="col-md-6 text-md-end mt-3 mt-md-0">
                        <button id="btnBackup" class="btn btn-warning me-2">
                            ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                        </button>
                        <button id="btnResetAll" class="btn btn-danger me-2">
                            ğŸ§¨ ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                        </button>
                        <button id="btnLogout" class="btn logout-btn">
                            ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
            <div class="row mb-3">
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="stat-card stat-card-1">
                        <h2 id="todayProfit">0</h2>
                        <p>ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="stat-card stat-card-2">
                        <h2 id="todaySoldQty">0</h2>
                        <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="stat-card stat-card-3">
                        <h2 id="totalProducts">0</h2>
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="stat-card stat-card-4">
                        <h2 id="lowStockCount">0</h2>
                        <p>Ø£ÙˆØ´ÙƒØª Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø¯</p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="stat-card stat-card-5">
                        <h2 id="todayTotalSales">0</h2>
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="stat-card stat-card-6">
                        <h2 id="totalInventoryValue">0</h2>
                        <p>Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                    </div>
                </div>
            </div>

            <!-- ÙƒØ±Øª ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ -->
            <div id="netProfitContainer"></div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± -->
            <div class="monthly-stats-section">
                <div class="row align-items-center">
                    <div class="col-12">
                        <h4 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">ğŸ“… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                    </div>
                </div>
                <div class="row justify-content-center">
                    <div class="col-md-4 col-sm-6">
                        <div class="monthly-stat-item">
                            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±</strong>
                            <span class="value" id="monthTotalProfit">0</span>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="monthly-stat-item">
                            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</strong>
                            <span class="value" id="monthTotalQty">0</span>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <div class="monthly-stat-item">
                            <strong>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</strong>
                            <span class="value" id="monthDaysCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
            <div class="main-menu">
                <div class="row g-3">
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-quick-sale">
                            <span class="menu-icon">âš¡</span>
                            <span class="menu-title">ÙØ§ØªÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø©</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-sales">
                            <span class="menu-icon">ğŸ’°</span>
                            <span class="menu-title">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-stock">
                            <span class="menu-icon">ğŸ“¦</span>
                            <span class="menu-title">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-customers">
                            <span class="menu-icon">ğŸ‘¥</span>
                            <span class="menu-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-moves">
                            <span class="menu-icon">ğŸ”</span>
                            <span class="menu-title">Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-stats">
                            <span class="menu-icon">ğŸ“Š</span>
                            <span class="menu-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-purchase">
                            <span class="menu-icon">ğŸ›’</span>
                            <span class="menu-title">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-expenses">
                            <span class="menu-icon">ğŸ’¸</span>
                            <span class="menu-title">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span>
                        </div>
                    </div>
                    <div class="col-4 col-md-2">
                        <div class="menu-tile" data-panel="panel-cash">
                            <span class="menu-icon">ğŸ’µ</span>
                            <span class="menu-title">Ø§Ù„Ø®Ø²Ù†Ø©</span>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- /container Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø©: ÙØ§ØªÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø© -->
        <div class="floating-panel-backdrop" id="panel-quick-sale">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">âš¡ ÙØ§ØªÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø©</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">ÙƒÙˆØ¯/Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                                        <input type="text" class="form-control" id="quickSaleSearch" 
                                               placeholder="Ø§Ø¨Ø¯Ø£ Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¨Ø­Ø«" list="productSuggestions">
                                        <datalist id="productSuggestions"></datalist>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                        <input type="number" class="form-control" id="quickSaleQty" value="1">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                                        <input type="number" step="0.01" class="form-control" id="quickSalePrice">
                                    </div>
                                    <button class="btn btn-success w-100" id="btnAddToInvoice">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                                    <th>Ø­Ø°Ù</th>
                                                </tr>
                                            </thead>
                                            <tbody id="quickInvoiceItems">
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="3" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                                    <td colspan="2"><strong id="quickInvoiceTotal">0.00</strong></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <div class="d-grid gap-2 mt-3">
                                        <button class="btn btn-primary" id="btnSaveQuickInvoice">ğŸ’¾ Ø­ÙØ¸ ÙˆØ·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                                        <button class="btn btn-secondary" id="btnClearQuickInvoice">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø©: Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div class="floating-panel-backdrop" id="panel-customers">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
                                </div>
                                <div class="card-body">
                                    <form id="customerForm">
                                        <input type="hidden" id="customerId">
                                        <div class="mb-3">
                                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                                            <input type="text" class="form-control" id="customerName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                            <input type="text" class="form-control" id="customerPhone">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
                                            <input type="number" step="0.01" class="form-control" id="customerBalance" value="0">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                            <textarea class="form-control" id="customerNotes" rows="2"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                                    <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                                    <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="customersBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø©: Ø§Ù„Ø®Ø²Ù†Ø© -->
        <div class="floating-panel-backdrop" id="panel-cash">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">ğŸ’µ Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø²Ù†Ø©</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h5>Ø±ØµÙŠØ¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</h5>
                                <h3 id="cashStartBalance">0.00</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <h5>Ø§Ù„Ø¯Ø§Ø®Ù„ (Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)</h5>
                                <h3 id="cashIncome">0.00</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <h5>Ø§Ù„Ø®Ø§Ø±Ø¬ (Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ)</h5>
                                <h3 id="cashOutgoing">0.00</h3>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-primary">
                                <h4>Ø±ØµÙŠØ¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</h4>
                                <h2 id="cashEndBalance">0.00</h2>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„ÙŠÙˆÙ…</h5>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td>Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‚Ø¯ÙŠ</td>
                                        <td id="cashSalesDetail">0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</td>
                                        <td id="cashExpensesDetail">0.00</td>
                                    </tr>
                                    <tr>
                                        <td>ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</td>
                                        <td id="cashNetDaily">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
        <div class="floating-panel-backdrop" id="panel-moves">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">â•â– Ø­Ø±ÙƒØ© Ù…Ø®Ø²ÙˆÙ†</h5>
                                </div>
                                <div class="card-body">
                                    <form id="stockMoveForm">
                                        <div class="mb-3">
                                            <label for="moveBarcode" class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <input type="text" class="form-control" id="moveBarcode" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="moveType" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©</label>
                                            <select id="moveType" class="form-select" required>
                                                <option value="in">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø±ØµÙŠØ¯</option>
                                                <option value="out">Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="moveQty" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                            <input type="number" class="form-control" id="moveQty" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="moveNote" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
                                            <input type="text" class="form-control" id="moveNote" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">ğŸ“Œ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“œ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="printSection('stockMovesTable')">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportToExcel('stockMovesTable','Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†')">ğŸ“„ Excel</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm" id="stockMovesTable">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="stockMovesBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- /row -->
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div class="floating-panel-backdrop" id="panel-stats">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>ğŸ“ˆ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù…</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="reportStartDate" class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                            <input type="date" class="form-control" id="reportStartDate">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="reportEndDate" class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                            <input type="date" class="form-control" id="reportEndDate">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-primary" onclick="generateReport()">
                                                    ğŸ” Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù…
                                                </button>
                                                <button class="btn btn-secondary" onclick="loadSavedReports()">
                                                    ğŸ“š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div id="quickStats">
                                        <div class="alert alert-light">
                                            <h6>ØªØ¹Ù„ÙŠÙ…Ø§Øª:</h6>
                                            <ol class="mb-0">
                                                <li>Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</li>
                                                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…ØªÙ‚Ø¯Ù…"</li>
                                                <li>Ø³ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙŠØ´Ù…Ù„:
                                                    <ul>
                                                        <li>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­</li>
                                                        <li>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</li>
                                                        <li>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</li>
                                                        <li>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</li>
                                                        <li>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</li>
                                                    </ul>
                                                </li>
                                                <li>ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£Ùˆ Ø·Ø¨Ø§Ø¹ØªÙ‡ Ø£Ùˆ Ø­ÙØ¸Ù‡</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>ğŸ“š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h5>
                                </div>
                                <div class="card-body">
                                    <div id="savedReportsList" class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ÙØªØ±Ø©</th>
                                                    <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                                    <th>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</th>
                                                    <th>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</th>
                                                    <th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</th>
                                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                                    <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="savedReportsBody">
                                                <tr>
                                                    <td colspan="7" class="text-center text-muted">
                                                        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
        <div class="floating-panel-backdrop" id="panel-purchase">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">ğŸ›’ ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</h5>
                                </div>
                                <div class="card-body">
                                    <form id="purchaseForm">
                                        <div class="mb-3">
                                            <label for="purchaseBarcode" class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <input type="text" class="form-control" id="purchaseBarcode" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="purchaseQty" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                            <input type="number" class="form-control" id="purchaseQty" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="purchasePrice" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                                            <input type="number" step="0.01" class="form-control" id="purchasePrice" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="purchaseSupplier" class="form-label">Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                                            <input type="text" class="form-control" id="purchaseSupplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">ğŸ’³ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="printSection('purchasesTable')">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportToExcel('purchasesTable','Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª')">ğŸ“„ Excel</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm" id="purchasesTable">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                                    <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchasesBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„Ù…ØµØ§Ø±ÙŠÙ -->
        <div class="floating-panel-backdrop" id="panel-expenses">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">â• ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h5>
                                </div>
                                <div class="card-body">
                                    <form id="expenseForm">
                                        <div class="mb-3">
                                            <label for="expenseType" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                                            <select id="expenseType" class="form-select" required>
                                                <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                                                <option value="Ø¥ÙŠØ¬Ø§Ø±">Ø¥ÙŠØ¬Ø§Ø±</option>
                                                <option value="Ù…Ø±ØªØ¨Ø§Øª">Ù…Ø±ØªØ¨Ø§Øª</option>
                                                <option value="Ø¥Ù†ØªØ±Ù†Øª">Ø¥Ù†ØªØ±Ù†Øª</option>
                                                <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
                                                <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                                                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="expenseAmount" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                                            <input type="number" class="form-control" id="expenseAmount" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="expenseNote" class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                            <textarea class="form-control" id="expenseNote" rows="2"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-danger w-100">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“Š Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="printSection('expensesTable')">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportToExcel('expensesTable','Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ')">ğŸ“„ Excel</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <div class="alert alert-warning">
                                                <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…: <span id="todayExpensesTotal">0</span> Ø¬.Ù…</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm" id="expensesTable">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                                    <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="expensesBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
        <div class="floating-panel-backdrop" id="panel-invoice">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div id="invoiceContent" style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
                        <div class="text-center mb-4">
                            <h3>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h3>
                            <h5>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø³Ù† Ù„Ù„Ù‡ÙˆØ§ØªÙ</h5>
                            <p id="invoiceDate"></p>
                            <p>Ø§Ù„Ø±Ù‚Ù…: <span id="invoiceNumber">0001</span></p>
                        </div>
                        <hr>
                        <table class="table table-bordered" id="invoiceTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                    <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItems">
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                    <td id="invoiceTotal">0</td>
                                </tr>
                            </tfoot>
                        </table>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ…</p>
                            </div>
                            <div class="col-6 text-end">
                                <p>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: ___________</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success w-100 mt-3" onclick="printInvoice()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ† -->
        <div class="floating-panel-backdrop" id="panel-stock">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <!-- Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h5>
                                </div>
                                <div class="card-body">
                                    <form id="productForm">
                                        <input type="hidden" id="productId">

                                        <div class="mb-3">
                                            <label for="productName" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <input type="text" class="form-control" id="productName" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="productBarcode" class="form-label">Ø¨Ø§Ø±ÙƒÙˆØ¯ / ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <input type="text" class="form-control" id="productBarcode" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠÙ‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="productCost" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</label>
                                                <input type="number" step="0.01" class="form-control" id="productCost" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="productQty" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                                <input type="number" class="form-control" id="productQty" required>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="productMinStock" class="form-label">Ø­Ø¯ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
                                            <input type="number" class="form-control" id="productMinStock" value="1">
                                        </div>

                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                                            <button type="button" class="btn btn-secondary" id="btnResetProduct">ğŸ”„ ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª + Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="printSection('productsTable')">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportToExcel('productsTable', 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª')">ğŸ“„ Excel</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" id="searchName" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…">
                                        </div>
                                        <div class="col-md-6 mt-2 mt-md-0">
                                            <input type="text" class="form-control" id="searchBarcode" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯">
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-hover" id="productsTable">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</th>
                                                    <th>Ø§Ù„Ù…ØªÙˆÙØ±</th>
                                                    <th>Ø­Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</th>
                                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                    <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productsBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆØ´ÙƒØª Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø¯ -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h5 class="mb-0">âš ï¸ Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆØ´ÙƒØª Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ§Ø¯</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 200px;">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                                    <th>Ø§Ù„ÙƒÙˆØ¯</th>
                                                    <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="lowStockBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- /col-lg-8 -->
                    </div> <!-- /row -->
                </div>
            </div>
        </div>

        <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø§Ø¦Ù…Ø© Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
        <div class="floating-panel-backdrop" id="panel-sales">
            <div class="floating-panel">
                <div class="floating-panel-header">
                    <span class="floating-panel-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                    <button class="floating-panel-close" data-close-panel>&times;</button>
                </div>
                <div class="floating-panel-body">
                    <div class="row">
                        <!-- ÙÙˆØ±Ù… Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬ -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">ğŸ’° Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬</h5>
                                </div>
                                <div class="card-body">
                                    <form id="saleForm">
                                        <div class="mb-3">
                                            <label for="saleBarcode" class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <input type="text" class="form-control" id="saleBarcode" placeholder="Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly>
                                        </div>

                                        <div class="mb-3">
                                            <label for="saleProductName" class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <input type="text" class="form-control" id="saleProductName" 
                                                   placeholder="Ø§Ø¨Ø¯Ø£ Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" list="productSuggestionsSale" 
                                                   autocomplete="off">
                                            <datalist id="productSuggestionsSale"></datalist>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="saleCost" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¬Ù…Ù„Ø©</label>
                                                <input type="number" class="form-control" id="saleCost" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="saleAvailableQty" class="form-label">Ø§Ù„Ù…ØªÙˆÙØ±</label>
                                                <input type="number" class="form-control" id="saleAvailableQty" readonly>
                                            </div>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="salePrice" class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                                                <input type="number" step="0.01" class="form-control" id="salePrice" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="saleQty" class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</label>
                                                <input type="number" class="form-control" id="saleQty" required value="1">
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-success w-100">âœ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“† Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="printSection('todaySalesTable')">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportToExcel('todaySalesTable','Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…')">ğŸ“„ Excel</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 250px;">
                                        <table class="table table-sm" id="todaySalesTable">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                                    <th>Ø§Ù„Ø±Ø¨Ø­</th>
                                                    <th>Ø¥Ø¯Ø§Ø±Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody id="todaySalesBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card mt-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h5>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="printSection('monthSalesTable')">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportToExcel('monthSalesTable','Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±')">ğŸ“„ Excel</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 250px;">
                                        <table class="table table-sm" id="monthSalesTable">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</th>
                                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</th>
                                                </tr>
                                            </thead>
                                            <tbody id="monthSalesBody">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div> <!-- /col-lg-8 -->
                    </div> <!-- /row -->
                </div>
            </div>
        </div>

    </div> <!-- /mainApp -->

    <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„ -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAoZE2KL3APojd929VEbhSv914jzDv90wA",
            authDomain: "test-dd8b4.firebaseapp.com",
            databaseURL: "https://test-dd8b4-default-rtdb.firebaseio.com",
            projectId: "test-dd8b4",
            storageBucket: "test-dd8b4.firebasestorage.app",
            messagingSenderId: "761689441004",
            appId: "1:761689441004:web:667a3fae42f3cf84071bc9",
            measurementId: "G-PP1BG203MT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
        const users = {
            "Ù…Ø¹ØªØ²": {
                password: "666666",
                permissions: ['sales', 'stock_view', 'expenses_view']
            },
            "Ù…ØµØ·ÙÙŠ": {
                password: "521988",
                permissions: ['admin', 'sales', 'stock_full', 'expenses_full', 'delete', 'reset', 'reports']
            }
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        let currentUser = null;
        let productsCache = [];
        let customersCache = [];
        let quickInvoiceItems = [];
        let stockMovesCache = [];
        let purchasesCache = [];
        let expensesCache = [];

        // ==================== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ====================

        function initLoginSystem() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                const sessionTime = localStorage.getItem('sessionTime');
                if (sessionTime && (Date.now() - parseInt(sessionTime)) < 24 * 60 * 60 * 1000) {
                    loginSuccess(userData);
                    return;
                } else {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('sessionTime');
                }
            }
            
            showLoginPage();
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            document.querySelectorAll('.user-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.user-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('loginUsername').value = this.dataset.user;
                    document.getElementById('loginPassword').focus();
                });
            });
            
            document.getElementById('btnClearLogin').addEventListener('click', function() {
                document.querySelectorAll('.user-option').forEach(opt => opt.classList.remove('active'));
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            });
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();
                
                if (!username || !password) {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                    return;
                }
                
                if (users[username] && users[username].password === password) {
                    const userData = {
                        name: username,
                        permissions: users[username].permissions
                    };
                    
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    localStorage.setItem('sessionTime', Date.now().toString());
                    
                    loginSuccess(userData);
                } else {
                    alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    document.getElementById('loginPassword').value = '';
                    document.getElementById('loginPassword').focus();
                }
            });
        }

        function loginSuccess(userData) {
            currentUser = userData;
            
            alert(`âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userData.name}! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
            
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('loggedUserInfo').textContent = `ğŸ‘¤ ${userData.name}`;
            
            loadAllData();
            loadAdvancedStats();
        }

        document.getElementById('btnLogout')?.addEventListener('click', function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('sessionTime');
                currentUser = null;
                showLoginPage();
            }
        });

        // ==================== ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================

        function loadAllData() {
            loadProducts();
            loadTodaySales();
            loadMonthSales();
            loadCustomers();
            loadStockMoves();
            loadPurchases();
            loadTodayExpenses();
            loadCashReport();
            loadSavedReports();
        }

        // ==================== ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© ====================

        function updateProductSuggestions() {
            const datalist = document.getElementById('productSuggestions');
            const datalistSale = document.getElementById('productSuggestionsSale');
            
            if (datalist) datalist.innerHTML = '';
            if (datalistSale) datalistSale.innerHTML = '';
            
            productsCache.forEach(product => {
                const option = document.createElement('option');
                const option2 = document.createElement('option');
                const displayText = `${product.name} - ${product.barcode || 'Ø¨Ø¯ÙˆÙ† ÙƒÙˆØ¯'} (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.qty})`;
                
                option.value = displayText;
                option.dataset.barcode = product.barcode;
                option.dataset.name = product.name;
                
                option2.value = displayText;
                option2.dataset.barcode = product.barcode;
                option2.dataset.name = product.name;
                
                if (datalist) datalist.appendChild(option);
                if (datalistSale) datalistSale.appendChild(option2);
            });
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø®ØªØ§Ø±
        function extractBarcodeFromSelection(selectedText) {
            const product = productsCache.find(p => 
                selectedText.includes(p.name) && 
                (selectedText.includes(p.barcode) || !p.barcode)
            );
            return product ? product.barcode : null;
        }

        // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø©
        document.getElementById('quickSaleSearch')?.addEventListener('change', function() {
            const selectedValue = this.value;
            const barcode = extractBarcodeFromSelection(selectedValue);
            
            if (barcode) {
                const product = productsCache.find(p => p.barcode === barcode);
                if (product) {
                    document.getElementById('quickSalePrice').value = product.cost;
                    this.value = product.name; // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
                }
            }
        });

        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨ÙŠØ¹
        document.getElementById('saleProductName')?.addEventListener('change', function() {
            const selectedValue = this.value;
            const barcode = extractBarcodeFromSelection(selectedValue);
            
            if (barcode) {
                loadProductByBarcode(barcode);
                const product = productsCache.find(p => p.barcode === barcode);
                if (product) {
                    document.getElementById('salePrice').value = product.cost;
                    document.getElementById('saleBarcode').value = barcode;
                    this.value = product.name; // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
                }
            }
        });

        // ==================== Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† ====================

        function loadProducts() {
            db.ref('products').on('value', snapshot => {
                productsCache = [];
                const productsBody = document.getElementById('productsBody');
                const lowStockBody = document.getElementById('lowStockBody');
                
                if (productsBody) productsBody.innerHTML = '';
                if (lowStockBody) lowStockBody.innerHTML = '';

                let totalProducts = 0;
                let lowStockCount = 0;
                let totalInventoryValue = 0;

                if (snapshot.exists()) {
                    const products = snapshot.val();
                    for (const key in products) {
                        const p = products[key];
                        p.id = key;
                        productsCache.push(p);
                        totalInventoryValue += (p.cost * p.qty);
                    }
                }

                renderProductsTable();

                productsCache.forEach(p => {
                    totalProducts++;
                    if (p.qty <= 0 || p.qty <= p.minStock) lowStockCount++;
                });

                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('lowStockCount').textContent = lowStockCount;
                document.getElementById('totalInventoryValue').textContent = totalInventoryValue.toFixed(2);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
                updateProductSuggestions();
            });
        }

        function renderProductsTable() {
            const productsBody = document.getElementById('productsBody');
            const lowStockBody = document.getElementById('lowStockBody');
            const searchNameInput = document.getElementById('searchName');
            const searchBarcodeInput = document.getElementById('searchBarcode');
            
            if (!productsBody) return;
            
            productsBody.innerHTML = '';
            if (lowStockBody) lowStockBody.innerHTML = '';

            const nameFilter = searchNameInput?.value.trim().toLowerCase() || '';
            const barcodeFilter = searchBarcodeInput?.value.trim().toLowerCase() || '';

            let lowStockItems = [];

            productsCache.forEach(p => {
                if (nameFilter && !p.name.toLowerCase().includes(nameFilter)) return;
                if (barcodeFilter && !(p.barcode || '').toLowerCase().includes(barcodeFilter)) return;

                let statusBadge = '';
                let rowClass = '';

                if (p.qty <= 0) {
                    statusBadge = '<span class="badge bg-danger">Ù†ÙØ¯</span>';
                    rowClass = 'out-stock';
                    lowStockItems.push(p);
                } else if (p.qty <= p.minStock) {
                    statusBadge = '<span class="badge bg-warning">Ù‚Ø±Ø¨ Ø§Ù„Ù†ÙØ§Ø¯</span>';
                    rowClass = 'low-stock';
                    lowStockItems.push(p);
                } else {
                    statusBadge = '<span class="badge bg-success">Ø¬ÙŠØ¯</span>';
                }

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td>${p.name}</td>
                    <td><code>${p.barcode || ''}</code></td>
                    <td>${parseFloat(p.cost).toFixed(2)}</td>
                    <td>${p.qty}</td>
                    <td>${p.minStock}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Ø­Ø°Ù</button>
                    </td>
                `;
                productsBody.appendChild(tr);
            });

            if (lowStockBody) {
                lowStockItems.forEach(p => {
                    let statusText = p.qty <= 0 ? 'Ù†ÙØ¯' : 'Ù‚Ø±Ø¨ Ø§Ù„Ù†ÙØ§Ø¯';
                    let statusClass = p.qty <= 0 ? 'danger' : 'warning';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.name}</td>
                        <td>${p.barcode || ''}</td>
                        <td>${p.qty}</td>
                        <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    `;
                    lowStockBody.appendChild(tr);
                });
            }
        }

        window.editProduct = function(id) {
            if (!currentUser || !currentUser.permissions.includes('stock_full')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
                return;
            }
            
            const found = productsCache.find(p => p.id === id);
            if (!found) return;

            document.getElementById('productId').value = id;
            document.getElementById('productName').value = found.name;
            document.getElementById('productBarcode').value = found.barcode || '';
            document.getElementById('productCost').value = found.cost;
            document.getElementById('productQty').value = found.qty;
            document.getElementById('productMinStock').value = found.minStock;

            document.getElementById('panel-stock').style.display = 'flex';
        };

        window.deleteProduct = function(id) {
            if (!currentUser || !currentUser.permissions.includes('delete')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
                return;
            }
            
            const pass = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬:');
            if (pass === null) return;
            if (pass !== '521988') {
                alert('âŒ Ø±Ù‚Ù… Ø³Ø±Ù‘ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
                return;
            }
            
            if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            
            db.ref('products/' + id).remove().then(() => {
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
            }).catch(err => {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + err.message);
            });
        };

        document.getElementById('productForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser || !currentUser.permissions.includes('stock_full')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
                return;
            }

            const id = document.getElementById('productId').value.trim();
            const name = document.getElementById('productName').value.trim();
            const barcode = document.getElementById('productBarcode').value.trim();
            const cost = parseFloat(document.getElementById('productCost').value) || 0;
            const qty = parseInt(document.getElementById('productQty').value) || 0;
            const minStock = parseInt(document.getElementById('productMinStock').value) || 0;

            if (!name) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
                return;
            }

            const data = { name, barcode, cost, qty, minStock };

            if (id) {
                db.ref('products/' + id).update(data);
            } else {
                const newRef = db.ref('products').push();
                newRef.set(data);
            }

            document.getElementById('btnResetProduct').click();
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        });

        document.getElementById('btnResetProduct')?.addEventListener('click', function() {
            document.getElementById('productId').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productBarcode').value = '';
            document.getElementById('productCost').value = '';
            document.getElementById('productQty').value = '';
            document.getElementById('productMinStock').value = '1';
        });

        // ==================== Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ====================

        function loadProductByBarcode(barcode) {
            const p = productsCache.find(pr => pr.barcode === barcode);
            if (!p) {
                document.getElementById('saleProductName').value = '';
                document.getElementById('saleCost').value = '';
                document.getElementById('saleAvailableQty').value = '';
                return false;
            }
            document.getElementById('saleProductName').value = p.name;
            document.getElementById('saleCost').value = p.cost;
            document.getElementById('saleAvailableQty').value = p.qty;
            return true;
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹
        document.getElementById('saleForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser || !currentUser.permissions.includes('sales')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª');
                return;
            }
            
            const barcode = document.getElementById('saleBarcode').value.trim();
            const price = parseFloat(document.getElementById('salePrice').value) || 0;
            const qty = parseInt(document.getElementById('saleQty').value) || 0;

            if (!barcode || qty <= 0 || price <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø¨ÙŠØ¹');
                return;
            }

            const product = productsCache.find(p => p.barcode === barcode);
            if (!product) {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
                return;
            }

            if (qty > product.qty) {
                alert('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªÙˆÙØ± ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
                return;
            }

            const totalSale = price * qty;
            const totalCost = product.cost * qty;
            const profit = totalSale - totalCost;

            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            const timeText = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

            const saleRef = db.ref('sales/' + dateKey).push();
            saleRef.set({
                barcode: barcode,
                name: product.name,
                qty: qty,
                price: price,
                totalSale: totalSale,
                totalCost: totalCost,
                profit: profit,
                time: timeText,
                seller: currentUser.name
            });

            db.ref('products/' + product.id).update({
                qty: product.qty - qty
            });

            document.getElementById('saleForm').reset();
            document.getElementById('saleQty').value = 1;
            
            alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­');
        });

        // ØªØ­Ù…ÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…
        function loadTodaySales() {
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            db.ref('sales/' + dateKey).on('value', snapshot => {
                const todaySalesBody = document.getElementById('todaySalesBody');
                if (todaySalesBody) todaySalesBody.innerHTML = '';
                
                let todayProfit = 0;
                let todayQty = 0;
                let todayTotalSales = 0;

                if (snapshot.exists()) {
                    const sales = snapshot.val();
                    for (const key in sales) {
                        const s = sales[key];
                        todayProfit += s.profit || 0;
                        todayQty += s.qty || 0;
                        todayTotalSales += s.totalSale || 0;

                        if (todaySalesBody) {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${s.time || ''}</td>
                                <td>${s.name || ''}</td>
                                <td>${s.qty || 0}</td>
                                <td>${s.price || 0}</td>
                                <td>${s.profit || 0}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSale('${dateKey}','${key}',${s.qty},'${s.barcode}')">Ø­Ø°Ù</button>
                                </td>
                            `;
                            todaySalesBody.appendChild(tr);
                        }
                    }
                }

                document.getElementById('todayProfit').textContent = todayProfit.toFixed(2);
                document.getElementById('todaySoldQty').textContent = todayQty;
                document.getElementById('todayTotalSales').textContent = todayTotalSales.toFixed(2);
            });
        }

        window.deleteSale = function(dateKey, saleId, qty, barcode) {
            if (!currentUser || !currentUser.permissions.includes('delete')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¨ÙŠØ¹');
                return;
            }
            
            const pass = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹:');
            if (pass === null) return;
            if (pass !== '521988') {
                alert('âŒ Ø±Ù‚Ù… Ø³Ø±Ù‘ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
                return;
            }
            
            if (!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

            const product = productsCache.find(p => p.barcode === barcode);
            db.ref('sales/' + dateKey + '/' + saleId).remove().then(() => {
                if (product) {
                    db.ref('products/' + product.id).update({
                        qty: product.qty + qty
                    });
                }
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙ…ÙŠØ©.');
            }).catch(err => {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: ' + err.message);
            });
        };

        // Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±
        function loadMonthSales() {
            const now = new Date();
            const currentMonth = now.toISOString().slice(0, 7);
            db.ref('sales').on('value', snapshot => {
                const monthSalesBody = document.getElementById('monthSalesBody');
                if (monthSalesBody) monthSalesBody.innerHTML = '';
                
                let monthProfit = 0;
                let monthQty = 0;
                let daysSet = new Set();

                if (snapshot.exists()) {
                    const allDays = snapshot.val();
                    for (const dayKey in allDays) {
                        if (!dayKey.startsWith(currentMonth)) continue;
                        const daySales = allDays[dayKey];
                        for (const saleId in daySales) {
                            const s = daySales[saleId];
                            monthProfit += s.profit || 0;
                            monthQty += s.qty || 0;
                            daysSet.add(dayKey);

                            if (monthSalesBody) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${dayKey}</td>
                                    <td>${s.name || ''}</td>
                                    <td>${s.qty || 0}</td>
                                    <td>${s.totalSale || 0}</td>
                                    <td>${s.profit || 0}</td>
                                `;
                                monthSalesBody.appendChild(tr);
                            }
                        }
                    }
                }

                document.getElementById('monthTotalProfit').textContent = monthProfit.toFixed(2);
                document.getElementById('monthTotalQty').textContent = monthQty;
                document.getElementById('monthDaysCount').textContent = daysSet.size;
            });
        }

        // ==================== ÙØ§ØªÙˆØ±Ø© Ø³Ø±ÙŠØ¹Ø© ====================

        document.getElementById('btnAddToInvoice')?.addEventListener('click', function() {
            const search = document.getElementById('quickSaleSearch').value.trim();
            const qty = parseInt(document.getElementById('quickSaleQty').value) || 1;
            const price = parseFloat(document.getElementById('quickSalePrice').value) || 0;

            if (!search || qty <= 0 || price <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                return;
            }

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù†Øµ
            const barcode = extractBarcodeFromSelection(search);
            const productName = search.split(' - ')[0]; // Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ (Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬)

            let product;
            if (barcode) {
                product = productsCache.find(p => p.barcode === barcode);
            } else {
                product = productsCache.find(p => p.name.includes(productName));
            }

            if (!product) {
                alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }

            if (qty > product.qty) {
                alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');
                return;
            }

            quickInvoiceItems.push({
                productId: product.id,
                name: product.name,
                barcode: product.barcode,
                qty: qty,
                price: price,
                total: qty * price,
                cost: product.cost
            });

            renderQuickInvoice();
            
            document.getElementById('quickSaleSearch').value = '';
            document.getElementById('quickSaleQty').value = 1;
            document.getElementById('quickSalePrice').value = '';
        });

        function renderQuickInvoice() {
            const tbody = document.getElementById('quickInvoiceItems');
            const totalEl = document.getElementById('quickInvoiceTotal');
            
            tbody.innerHTML = '';
            let grandTotal = 0;

            quickInvoiceItems.forEach((item, index) => {
                grandTotal += item.total;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.qty}</td>
                    <td>${item.price.toFixed(2)}</td>
                    <td>${item.total.toFixed(2)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removeFromQuickInvoice(${index})">Ã—</button></td>
                `;
                tbody.appendChild(tr);
            });

            totalEl.textContent = grandTotal.toFixed(2);
        }

        window.removeFromQuickInvoice = function(index) {
            quickInvoiceItems.splice(index, 1);
            renderQuickInvoice();
        };

        document.getElementById('btnSaveQuickInvoice')?.addEventListener('click', function() {
            if (quickInvoiceItems.length === 0) {
                alert('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©');
                return;
            }

            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            const timeText = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

            quickInvoiceItems.forEach(item => {
                const profit = (item.price - item.cost) * item.qty;
                const saleRef = db.ref('sales/' + dateKey).push();
                saleRef.set({
                    barcode: item.barcode,
                    name: item.name,
                    qty: item.qty,
                    price: item.price,
                    totalSale: item.total,
                    totalCost: item.cost * item.qty,
                    profit: profit,
                    time: timeText,
                    seller: currentUser?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
                });

                const product = productsCache.find(p => p.id === item.productId);
                if (product) {
                    db.ref('products/' + product.id).update({
                        qty: product.qty - item.qty
                    });
                }
            });

            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            quickInvoiceItems = [];
            renderQuickInvoice();
        });

        document.getElementById('btnClearQuickInvoice')?.addEventListener('click', function() {
            quickInvoiceItems = [];
            renderQuickInvoice();
        });

        // ==================== Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ====================

        function loadCustomers() {
            db.ref('customers').on('value', snapshot => {
                customersCache = [];
                const tbody = document.getElementById('customersBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (snapshot.exists()) {
                    const customers = snapshot.val();
                    for (const key in customers) {
                        const c = customers[key];
                        c.id = key;
                        customersCache.push(c);

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${c.name}</td>
                            <td>${c.phone || ''}</td>
                            <td>${c.balance || 0}</td>
                            <td>${c.notes || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="editCustomer('${key}')">ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${key}')">Ø­Ø°Ù</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
            });
        }

        document.getElementById('customerForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            const id = document.getElementById('customerId').value.trim();
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const balance = parseFloat(document.getElementById('customerBalance').value) || 0;
            const notes = document.getElementById('customerNotes').value.trim();

            if (!name) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„');
                return;
            }

            const data = { name, phone, balance, notes };

            if (id) {
                db.ref('customers/' + id).update(data);
            } else {
                const newRef = db.ref('customers').push();
                newRef.set(data);
            }

            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
        });

        window.editCustomer = function(id) {
            const customer = customersCache.find(c => c.id === id);
            if (!customer) return;

            document.getElementById('customerId').value = id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerBalance').value = customer.balance || 0;
            document.getElementById('customerNotes').value = customer.notes || '';

            document.getElementById('panel-customers').style.display = 'flex';
        };

        window.deleteCustomer = function(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
            
            db.ref('customers/' + id).remove()
                .then(() => alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„'))
                .catch(err => alert('âŒ Ø®Ø·Ø£: ' + err.message));
        };

        // ==================== Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ====================

        function loadStockMoves() {
            db.ref('stockMoves').on('value', snapshot => {
                stockMovesCache = [];
                const tbody = document.getElementById('stockMovesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (snapshot.exists()) {
                    const moves = snapshot.val();
                    for (const key in moves) {
                        const m = moves[key];
                        m.id = key;
                        stockMovesCache.push(m);

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${m.date || ''}</td>
                            <td>${m.barcode || ''}</td>
                            <td>${m.type === 'in' ? 'Ø¥Ø¶Ø§ÙØ©' : 'Ø®ØµÙ…'}</td>
                            <td>${m.qty || 0}</td>
                            <td>${m.note || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
            });
        }

        document.getElementById('stockMoveForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const barcode = document.getElementById('moveBarcode').value.trim();
            const type = document.getElementById('moveType').value;
            const qty = parseInt(document.getElementById('moveQty').value) || 0;
            const note = document.getElementById('moveNote').value.trim();

            if (!barcode || qty <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                return;
            }

            const product = productsCache.find(p => p.barcode === barcode);
            if (!product) {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
                return;
            }

            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];

            const newRef = db.ref('stockMoves').push();
            newRef.set({
                date: dateKey,
                barcode: barcode,
                name: product.name,
                type: type,
                qty: qty,
                note: note,
                time: now.toLocaleTimeString('ar-EG')
            });

            let newQty = product.qty;
            if (type === 'in') {
                newQty += qty;
            } else {
                newQty -= qty;
                if (newQty < 0) newQty = 0;
            }

            db.ref('products/' + product.id).update({
                qty: newQty
            });

            document.getElementById('stockMoveForm').reset();
            alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­');
        });

        // ==================== Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ====================

        function loadPurchases() {
            db.ref('purchases').on('value', snapshot => {
                purchasesCache = [];
                const tbody = document.getElementById('purchasesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (snapshot.exists()) {
                    const purchases = snapshot.val();
                    for (const key in purchases) {
                        const p = purchases[key];
                        p.id = key;
                        purchasesCache.push(p);

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${p.date || ''}</td>
                            <td>${p.barcode || ''}</td>
                            <td>${p.qty || 0}</td>
                            <td>${p.price || 0}</td>
                            <td>${p.supplier || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
            });
        }

        document.getElementById('purchaseForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const barcode = document.getElementById('purchaseBarcode').value.trim();
            const qty = parseInt(document.getElementById('purchaseQty').value) || 0;
            const price = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const supplier = document.getElementById('purchaseSupplier').value.trim();

            if (!barcode || qty <= 0 || price <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©');
                return;
            }

            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];

            const newRef = db.ref('purchases').push();
            newRef.set({
                date: dateKey,
                barcode: barcode,
                qty: qty,
                price: price,
                total: qty * price,
                supplier: supplier,
                time: now.toLocaleTimeString('ar-EG')
            });

            const product = productsCache.find(p => p.barcode === barcode);
            if (product) {
                db.ref('products/' + product.id).update({
                    qty: product.qty + qty,
                    cost: price
                });
            }

            document.getElementById('purchaseForm').reset();
            alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
        });

        // ==================== Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ====================

        function loadTodayExpenses() {
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];
            
            db.ref('expenses/' + dateKey).on('value', snapshot => {
                expensesCache = [];
                const tbody = document.getElementById('expensesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalExpenses = 0;

                if (snapshot.exists()) {
                    const expenses = snapshot.val();
                    for (const key in expenses) {
                        const exp = expenses[key];
                        exp.id = key;
                        expensesCache.push(exp);
                        totalExpenses += exp.amount || 0;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${exp.time || ''}</td>
                            <td>${exp.type || ''}</td>
                            <td>${exp.amount || 0}</td>
                            <td>${exp.note || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteExpense('${dateKey}','${key}')">Ø­Ø°Ù</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                }

                document.getElementById('todayExpensesTotal').textContent = totalExpenses.toFixed(2);
            });
        }

        window.deleteExpense = function(dateKey, expenseId) {
            if (!currentUser || !currentUser.permissions.includes('expenses_full')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ');
                return;
            }
            
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
            
            db.ref('expenses/' + dateKey + '/' + expenseId).remove()
                .then(() => alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ'))
                .catch(err => alert('âŒ Ø®Ø·Ø£: ' + err.message));
        };

        document.getElementById('expenseForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const note = document.getElementById('expenseNote').value.trim();

            if (amount <= 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }

            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];

            const newRef = db.ref('expenses/' + dateKey).push();
            newRef.set({
                type: type,
                amount: amount,
                note: note,
                time: now.toLocaleTimeString('ar-EG'),
                addedBy: currentUser.name
            });

            document.getElementById('expenseForm').reset();
            document.getElementById('expenseType').value = 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡';
            alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
        });

        // ==================== Ø§Ù„Ø®Ø²Ù†Ø© ====================

        function loadCashReport() {
            const now = new Date();
            const dateKey = now.toISOString().split('T')[0];

            db.ref('sales/' + dateKey).once('value', salesSnapshot => {
                let totalSales = 0;
                if (salesSnapshot.exists()) {
                    const sales = salesSnapshot.val();
                    for (const key in sales) {
                        totalSales += sales[key].totalSale || 0;
                    }
                }

                db.ref('expenses/' + dateKey).once('value', expSnapshot => {
                    let totalExpenses = 0;
                    if (expSnapshot.exists()) {
                        const expenses = expSnapshot.val();
                        for (const key in expenses) {
                            totalExpenses += expenses[key].amount || 0;
                        }
                    }

                    const netDaily = totalSales - totalExpenses;

                    document.getElementById('cashStartBalance').textContent = '0.00';
                    document.getElementById('cashIncome').textContent = totalSales.toFixed(2);
                    document.getElementById('cashOutgoing').textContent = totalExpenses.toFixed(2);
                    document.getElementById('cashEndBalance').textContent = netDaily.toFixed(2);
                    document.getElementById('cashSalesDetail').textContent = totalSales.toFixed(2);
                    document.getElementById('cashExpensesDetail').textContent = totalExpenses.toFixed(2);
                    document.getElementById('cashNetDaily').textContent = netDaily.toFixed(2);
                });
            });
        }

        // ==================== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© ====================

        function loadAdvancedStats() {
            if (!currentUser) return;
            
            const now = new Date();
            const todayKey = now.toISOString().split('T')[0];
            
            db.ref('expenses/' + todayKey).once('value', expSnapshot => {
                let expensesTotal = 0;
                if (expSnapshot.exists()) {
                    const expenses = expSnapshot.val();
                    for (const key in expenses) {
                        expensesTotal += expenses[key].amount || 0;
                    }
                }
                
                db.ref('sales/' + todayKey).once('value', salesSnapshot => {
                    let profitTotal = 0;
                    if (salesSnapshot.exists()) {
                        const sales = salesSnapshot.val();
                        for (const key in sales) {
                            profitTotal += sales[key].profit || 0;
                        }
                    }
                    
                    const netProfit = profitTotal - expensesTotal;
                    
                    const netProfitContainer = document.getElementById('netProfitContainer');
                    if (netProfitContainer) {
                        netProfitContainer.innerHTML = `
                            <div class="row mb-3 justify-content-center">
                                <div class="col-md-3 col-sm-6">
                                    <div class="stat-card ${netProfit >= 0 ? 'stat-card-1' : 'stat-card-4'}">
                                        <h2 id="netProfit">${netProfit.toFixed(2)}</h2>
                                        <p>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ)</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
        }

        setInterval(loadAdvancedStats, 60000);

        // ==================== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ====================

        window.generateReport = function() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;

            if (!startDate || !endDate) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
                return;
            }

            if (startDate > endDate) {
                alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
                return;
            }

            Promise.all([
                db.ref('sales').once('value'),
                db.ref('expenses').once('value'),
                db.ref('purchases').once('value')
            ]).then(([salesSnapshot, expensesSnapshot, purchasesSnapshot]) => {
                const salesData = salesSnapshot.val() || {};
                const expensesData = expensesSnapshot.val() || {};
                const purchasesData = purchasesSnapshot.val() || {};

                let totalSales = 0;
                let totalProfit = 0;
                let totalQty = 0;
                let totalExpenses = 0;
                let totalPurchases = 0;
                const productSales = {};
                const userSales = {};
                const expensesByType = {};

                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                for (const dateKey in salesData) {
                    if (dateKey >= startDate && dateKey <= endDate) {
                        const daySales = salesData[dateKey];
                        for (const saleKey in daySales) {
                            const sale = daySales[saleKey];
                            totalSales += sale.totalSale || 0;
                            totalProfit += sale.profit || 0;
                            totalQty += sale.qty || 0;

                            // ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬
                            const productName = sale.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            if (!productSales[productName]) {
                                productSales[productName] = { qty: 0, sales: 0, profit: 0 };
                            }
                            productSales[productName].qty += sale.qty || 0;
                            productSales[productName].sales += sale.totalSale || 0;
                            productSales[productName].profit += sale.profit || 0;

                            // ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                            const seller = sale.seller || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                            if (!userSales[seller]) {
                                userSales[seller] = { qty: 0, sales: 0, profit: 0 };
                            }
                            userSales[seller].qty += sale.qty || 0;
                            userSales[seller].sales += sale.totalSale || 0;
                            userSales[seller].profit += sale.profit || 0;
                        }
                    }
                }

                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
                for (const dateKey in expensesData) {
                    if (dateKey >= startDate && dateKey <= endDate) {
                        const dayExpenses = expensesData[dateKey];
                        for (const expKey in dayExpenses) {
                            const exp = dayExpenses[expKey];
                            totalExpenses += exp.amount || 0;

                            const expType = exp.type || 'Ø£Ø®Ø±Ù‰';
                            if (!expensesByType[expType]) {
                                expensesByType[expType] = 0;
                            }
                            expensesByType[expType] += exp.amount || 0;
                        }
                    }
                }

                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
                for (const key in purchasesData) {
                    const purchase = purchasesData[key];
                    if (purchase.date >= startDate && purchase.date <= endDate) {
                        totalPurchases += purchase.total || 0;
                    }
                }

                const netProfit = totalProfit - totalExpenses;

                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                const topProducts = Object.entries(productSales)
                    .sort((a, b) => b[1].sales - a[1].sales)
                    .slice(0, 10);

                // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                displayReport({
                    startDate,
                    endDate,
                    totalSales,
                    totalProfit,
                    totalQty,
                    totalExpenses,
                    totalPurchases,
                    netProfit,
                    topProducts,
                    userSales,
                    expensesByType
                });

            }).catch(error => {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
            });
        };

        function displayReport(reportData) {
            window.currentReport = reportData;

            let reportHtml = `
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù…Ù† ${reportData.startDate} Ø¥Ù„Ù‰ ${reportData.endDate}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="alert alert-info">
                                    <h6>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h6>
                                    <h4>${reportData.totalSales.toFixed(2)} Ø¬.Ù…</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-success">
                                    <h6>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­</h6>
                                    <h4>${reportData.totalProfit.toFixed(2)} Ø¬.Ù…</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert alert-warning">
                                    <h6>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h6>
                                    <h4>${reportData.totalExpenses.toFixed(2)} Ø¬.Ù…</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="alert ${reportData.netProfit >= 0 ? 'alert-primary' : 'alert-danger'}">
                                    <h6>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h6>
                                    <h4>${reportData.netProfit.toFixed(2)} Ø¬.Ù…</h4>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6>ğŸ“¦ Ø£ÙØ¶Ù„ 10 Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                            <th>Ø§Ù„Ø±Ø¨Ø­</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;

            reportData.topProducts.forEach(([name, data]) => {
                reportHtml += `
                    <tr>
                        <td>${name}</td>
                        <td>${data.qty}</td>
                        <td>${data.sales.toFixed(2)}</td>
                        <td>${data.profit.toFixed(2)}</td>
                    </tr>
                `;
            });

            reportHtml += `
                                    </tbody>
                                </table>
                            </div>

                            <div class="col-md-6">
                                <h6>ğŸ‘¥ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                            <th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
                                            <th>Ø§Ù„Ø±Ø¨Ø­</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;

            for (const user in reportData.userSales) {
                const data = reportData.userSales[user];
                reportHtml += `
                    <tr>
                        <td>${user}</td>
                        <td>${data.qty}</td>
                        <td>${data.sales.toFixed(2)}</td>
                        <td>${data.profit.toFixed(2)}</td>
                    </tr>
                `;
            }

            reportHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6>ğŸ’¸ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h6>
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
                                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                            <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;

            for (const type in reportData.expensesByType) {
                const amount = reportData.expensesByType[type];
                const percentage = reportData.totalExpenses > 0 ? (amount / reportData.totalExpenses * 100).toFixed(1) : 0;
                reportHtml += `
                    <tr>
                        <td>${type}</td>
                        <td>${amount.toFixed(2)} Ø¬.Ù…</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }

            reportHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="printReport()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                                    <button class="btn btn-success" onclick="exportReportToExcel()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
                                    <button class="btn btn-info" onclick="saveReport()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const statsSection = document.getElementById('quickStats');
            if (statsSection) {
                statsSection.innerHTML = reportHtml;
            }
        }

        window.printReport = function() {
            if (!window.currentReport) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ø·Ø¨Ø§Ø¹ØªÙ‡');
                return;
            }
            window.print();
        };

        window.exportReportToExcel = function() {
            if (!window.currentReport) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„ØªØµØ¯ÙŠØ±Ù‡');
                return;
            }

            let csv = 'ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„\n';
            csv += `Ø§Ù„ÙØªØ±Ø©:,${window.currentReport.startDate},Ø¥Ù„Ù‰,${window.currentReport.endDate}\n\n`;
            csv += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª,' + window.currentReport.totalSales.toFixed(2) + '\n';
            csv += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¨Ø­,' + window.currentReport.totalProfit.toFixed(2) + '\n';
            csv += 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ,' + window.currentReport.totalExpenses.toFixed(2) + '\n';
            csv += 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­,' + window.currentReport.netProfit.toFixed(2) + '\n\n';

            csv += 'Ø£ÙØ¶Ù„ 10 Ù…Ù†ØªØ¬Ø§Øª\n';
            csv += 'Ø§Ù„Ù…Ù†ØªØ¬,Ø§Ù„ÙƒÙ…ÙŠØ©,Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª,Ø§Ù„Ø±Ø¨Ø­\n';
            window.currentReport.topProducts.forEach(([name, data]) => {
                csv += `"${name}",${data.qty},${data.sales.toFixed(2)},${data.profit.toFixed(2)}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ØªÙ‚Ø±ÙŠØ±-' + window.currentReport.startDate + '-to-' + window.currentReport.endDate + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        function saveReport() {
            if (!window.currentReport) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø±ÙŠØ± Ù„Ø­ÙØ¸Ù‡');
                return;
            }

            const now = new Date();
            const reportRef = db.ref('reports').push();
            reportRef.set({
                ...window.currentReport,
                createdBy: currentUser.name,
                createdAt: now.toISOString()
            }).then(() => {
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
                loadSavedReports();
            }).catch(err => {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + err.message);
            });
        }

        window.loadSavedReports = function() {
            db.ref('reports').once('value').then(snapshot => {
                const tbody = document.getElementById('savedReportsBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (snapshot.exists()) {
                    const reports = snapshot.val();
                    for (const key in reports) {
                        const r = reports[key];
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${r.startDate} Ø¥Ù„Ù‰ ${r.endDate}</td>
                            <td>${r.totalSales.toFixed(2)}</td>
                            <td>${r.totalProfit.toFixed(2)}</td>
                            <td>${r.totalExpenses.toFixed(2)}</td>
                            <td>${r.netProfit.toFixed(2)}</td>
                            <td>${new Date(r.createdAt).toLocaleDateString('ar-EG')}</td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" onclick="viewSavedReport('${key}')">Ø¹Ø±Ø¶</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSavedReport('${key}')">Ø­Ø°Ù</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©
                            </td>
                        </tr>
                    `;
                }
            });
        };

        window.viewSavedReport = function(reportId) {
            db.ref('reports/' + reportId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const reportData = snapshot.val();
                    displayReport(reportData);
                    document.getElementById('panel-stats').style.display = 'flex';
                }
            });
        };

        window.deleteSavedReport = function(reportId) {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±');
                return;
            }

            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ')) return;

            db.ref('reports/' + reportId).remove()
                .then(() => {
                    alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
                    loadSavedReports();
                })
                .catch(err => alert('âŒ Ø®Ø·Ø£: ' + err.message));
        };

        // ==================== Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ====================

        document.getElementById('btnBackup')?.addEventListener('click', function() {
            if (!currentUser || !currentUser.permissions.includes('admin')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
                return;
            }

            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† ÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;

            const backupData = {
                products: productsCache,
                customers: customersCache,
                exportDate: new Date().toISOString(),
                exportedBy: currentUser.name
            };

            db.ref('sales').once('value', salesSnapshot => {
                backupData.sales = salesSnapshot.val() || {};
                
                db.ref('expenses').once('value', expensesSnapshot => {
                    backupData.expenses = expensesSnapshot.val() || {};
                    
                    db.ref('purchases').once('value', purchasesSnapshot => {
                        backupData.purchases = purchasesSnapshot.val() || {};
                        
                        db.ref('stockMoves').once('value', movesSnapshot => {
                            backupData.stockMoves = movesSnapshot.val() || {};

                            const json = JSON.stringify(backupData, null, 2);
                            const blob = new Blob([json], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'backup-' + new Date().toISOString().split('T')[0] + '.json';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);

                            alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                        });
                    });
                });
            });
        });

        // ==================== ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================

        document.getElementById('btnResetAll')?.addEventListener('click', function() {
            if (!currentUser || !currentUser.permissions.includes('reset')) {
                alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return;
            }

            const pass = prompt('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ!\n\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (521988) Ù„Ù„ØªØ£ÙƒÙŠØ¯:');
            if (pass === null) return;
            if (pass !== '521988') {
                alert('âŒ Ø±Ù‚Ù… Ø³Ø±Ù‘ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
                return;
            }

            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!')) return;

            db.ref('sales').remove()
                .then(() => {
                    return db.ref('expenses').remove();
                })
                .then(() => {
                    return db.ref('purchases').remove();
                })
                .then(() => {
                    return db.ref('stockMoves').remove();
                })
                .then(() => {
                    alert('âœ… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    location.reload();
                })
                .catch(err => {
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙÙŠØ±: ' + err.message);
                });
        });

        // ==================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ====================

        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const el = document.getElementById('currentDateTime');
            if (el) {
                el.textContent = now.toLocaleString('ar-EG', options);
            }
        }
        updateDateTime();
        setInterval(updateDateTime, 60000);

        window.printSection = function(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            const w = window.open('', '_blank');
            w.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø©</title>');
            w.document.write('<style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:5px;text-align:center}body{direction:rtl;font-family:Arial;padding:20px}</style>');
            w.document.write('</head><body>');
            w.document.write(table.outerHTML);
            w.document.write('</body></html>');
            w.document.close();
            w.print();
        };

        window.exportToExcel = function(tableId, sheetName) {
            const table = document.getElementById(tableId);
            if (!table) return;
            let csv = '';
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('th,td');
                let rowData = [];
                cols.forEach(col => {
                    let text = col.innerText.replace(/"/g, '""');
                    rowData.push('"' + text + '"');
                });
                csv += rowData.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = sheetName + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.printInvoice = function() {
            const invoiceContent = document.getElementById('invoiceContent');
            const w = window.open('', '_blank');
            w.document.write('<html><head><title>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</title>');
            w.document.write('<style>body{direction:rtl;font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:8px;text-align:center}.text-center{text-align:center}.text-end{text-align:left}</style>');
            w.document.write('</head><body>');
            w.document.write(invoiceContent.innerHTML);
            w.document.write('</body></html>');
            w.document.close();
            w.print();
        };

        // ==================== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ====================

        document.querySelectorAll('.menu-tile').forEach(tile => {
            tile.addEventListener('click', () => {
                if (!currentUser) return;
                const panelId = tile.getAttribute('data-panel');
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'flex';
                }
            });
        });

        document.querySelectorAll('[data-close-panel]').forEach(btn => {
            btn.addEventListener('click', () => {
                const backdrop = btn.closest('.floating-panel-backdrop');
                if (backdrop) backdrop.style.display = 'none';
            });
        });

        document.querySelectorAll('.floating-panel-backdrop').forEach(backdrop => {
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    backdrop.style.display = 'none';
                }
            });
        });

        // ==================== Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ====================

        document.getElementById('searchName')?.addEventListener('input', renderProductsTable);
        document.getElementById('searchBarcode')?.addEventListener('input', renderProductsTable);

        // ==================== Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ====================

        initLoginSystem();
    </script>
</body>
</html>
